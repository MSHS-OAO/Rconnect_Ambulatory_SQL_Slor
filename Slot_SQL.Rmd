---
title: "Slot_SQL"
date: "2024-01-12"
output: html_document

---

```{r}
library(glue)
library(odbc)
library(tidyverse)
library(DBI)
library(pool)

date_1 <- "2021-01-01"
date_2 <- Sys.Date() %m+% months(6)

#MApping for V_AVAILABILITY
slot_mapping_drop <- glue("DROP TABLE AMBULATORY_SLOT_MAPPING")
slot_mapping <- glue("CREATE TABLE AMBULATORY_SLOT_MAPPING AS 
                     SELECT DISTINCT DEP_RPT_GRP_SEVENTEEN  AS CAMPUS, DEPT_SPECIALTY_NAME AS CAMPUS_SPECIALTY, DEPARTMENT_ID, DEPARTMENT_NAME AS DEPARTMENT                        FROM MV_DM_PATIENT_ACCESS")


### Only return relevant rows from access table and return distinct rows
raw_access_drop <- glue("DROP TABLE AMBULATORY_ACCESS_RAW_FILTERED")
raw_access_query <- glue("CREATE TABLE AMBULATORY_ACCESS_RAW_FILTERED AS 
SELECT d.* FROM(
    SELECT c.*, ROW_NUMBER() OVER (PARTITION BY DEPARTMENT_ID, PROV_ID, APPT_DTTM, MRN ORDER BY DEPARTMENT_ID, PROV_ID, APPT_DTTM, MRN, APPT_MADE_DTTM DESC) AS ROW_ID 
        FROM (
            Select a.* , b.SLOT_DATE, b.SLOT_BEGIN_TIME FROM(
                (SELECT * FROM( 
                  SELECT PAT_ENC_CSN_ID, SITE AS CAMPUS, DEPARTMENT_NAME, 
                   DEPARTMENT_ID, PROV_NAME_WID, PROV_ID, DEPT_SPECIALTY_NAME, NPI, VISIT_PROV_STAFF_RESOURCE_C,
                    DERIVED_STATUS_DESC AS APPT_STATUS, APPT_DTTM, MRN,
                    TRUNC(APPT_DTTM) AS APPT_DATE,
                     TO_CHAR(APPT_DTTM, 'yyyy-mm') AS APPT_MONTH_YEAR,
                     (APPT_LENGTH) AS APPT_LENGTH_MINS, OVERBOOKED_YN, APPT_MADE_DTTM, APPT_CANC_DTTM
                     FROM MV_DM_PATIENT_ACCESS 
                     WHERE APPT_DTTM BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
                        AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS'))) a
                INNER JOIN
                (SELECT * FROM( 
                SELECT DISTINCT DEPARTMENT_ID, PROV_ID, SLOT_DATE, SLOT_BEGIN_TIME FROM( 
                  SELECT DISTINCT DEPARTMENT_NAME, DEPARTMENT_ID, PROV_NM_WID, PROV_ID,
                   SLOT_BEGIN_TIME, SLOT_DATE, TO_CHAR(SLOT_DATE, 'yyyy-mm') AS SLOT_MONTH_YEAR, SLOT_LENGTH
                    FROM V_AVAILABILITY 
                     WHERE UNAVAILABLE_RSN_C IS NULL AND SLOT_DATE BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
                        AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS')))) b
            ON a.DEPARTMENT_ID = b.DEPARTMENT_ID AND a.PROV_ID = b.PROV_ID 
                AND a.APPT_DTTM = b.SLOT_BEGIN_TIME
            ) ORDER BY a.APPT_MADE_DTTM DESC
    ) c
)d WHERE d.ROW_ID = 1;")


raw_access_index <- glue("CREATE index raw_access_index on AMBULATORY_ACCESS_RAW_FILTERED (APPT_DATE, DEPARTMENT_ID, CAMPUS)")



### Create queries for summing scheduled and arrived hours
access_sched_arived_hours_drop <- glue("DROP TABLE AMBULATORY_ACCESS_SCHED_ARRIVED_HOURS")
access_sched_arived_hours_quary <- glue("CREATE TABLE AMBULATORY_ACCESS_SCHED_ARRIVED_HOURS AS 
                           SELECT a.CAMPUS, a.DEPARTMENT_ID, a.DEPARTMENT_NAME, a.PROV_ID, a.PROV_NAME_WID, a.DEPT_SPECIALTY_NAME,                                  a.APPT_DATE, a.NPI, a.VISIT_PROV_STAFF_RESOURCE_C,
                           sum(a.APPT_LENGTH_MINS) AS SCHEDULED_MINS, sum(b.APPT_LENGTH_MINS) AS ARRIVED_MINS
                           FROM 
                           ((SELECT * FROM AMBULATORY_ACCESS_RAW_FILTERED
                            WHERE (APPT_STATUS IN ('Arrived', 'No Show','Scheduled')) OR
                           (APPT_STATUS IN  ('Canceled', 'Rescheduled', 'Bumped') AND 
                            TO_CHAR(APPT_DTTM, 'YYYY-MM-DD') = TO_CHAR(APPT_CANC_DTTM, 'YYYY-MM-DD'))) a
                            LEFT JOIN
                           (SELECT * FROM AMBULATORY_ACCESS_RAW_FILTERED
                            WHERE APPT_STATUS = 'Arrived') b
                            ON a.PAT_ENC_CSN_ID = b.PAT_ENC_CSN_ID)
                            GROUP BY a.CAMPUS, a.DEPARTMENT_ID, a.DEPARTMENT_NAME, a.PROV_ID, a.PROV_NAME_WID, a.DEPT_SPECIALTY_NAME,                                                      a.APPT_DATE, a.NPI, a.VISIT_PROV_STAFF_RESOURCE_C
                           ")


access_sched_arived_hours_index <- glue("CREATE index access_sched_arived_index on AMBULATORY_ACCESS_SCHED_ARRIVED_HOURS (APPT_DATE, DEPARTMENT_ID, CAMPUS)")

###Creating query for getting unique combination of DEPARTMENT_ID, DEPARTMENT_NAME, PROV_NM_WID, PROV_ID, SLOT_DATE, SLOT_MONTH_YEAR
base_slot_drop <- glue("DROP TABLE AMBULATORY_BASE_SLOT_TABLE")
base_slot_query <- glue("CREATE TABLE AMBULATORY_BASE_SLOT_TABLE AS
                        SELECT a.*, b.NPI, b.VISIT_PROV_STAFF_RESOURCE_C
                        FROM
                        (SELECT DISTINCT DEPARTMENT_ID, DEPARTMENT_NAME, PROV_NM_WID, PROV_ID, SLOT_DATE, TO_CHAR(SLOT_DATE, 'yyyy-mm') AS SLOT_MONTH_YEAR
                        FROM V_AVAILABILITY
                        WHERE UNAVAILABLE_RSN_C IS NULL
                        AND SLOT_DATE BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
                        AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
                        GROUP BY DEPARTMENT_ID, DEPARTMENT_NAME, PROV_NM_WID, PROV_ID, SLOT_DATE, TO_CHAR(SLOT_DATE, 'yyyy-mm')) a
                        LEFT JOIN
                        (SELECT DISTINCT PROV_ID, NPI, VISIT_PROV_STAFF_RESOURCE_C
                         FROM MV_DM_PATIENT_ACCESS) b
                        ON a.PROV_ID = b.PROV_ID;")

base_slot_index <- glue("CREATE index base_slot_index on AMBULATORY_BASE_SLOT_TABLE (SLOT_DATE, DEPARTMENT_ID)")
                        
                        
                        
### Create queries for summing available hours
availability_raw_drop <- glue("DROP TABLE AMBULATORY_AVAILABILITY_ACCESS_TABLE")
availability_raw_query<- glue("CREATE TABLE AMBULATORY_AVAILABILITY_ACCESS_TABLE AS
                           SELECT DEPARTMENT_ID, DEPARTMENT_NAME, PROV_NM_WID, PROV_ID,
                           SLOT_DATE, TO_CHAR(SLOT_DATE, 'yyyy-mm') AS SLOT_MONTH_YEAR, SUM(SLOT_LENGTH) AS AVAILABLE_MINS
                           FROM
                           (SELECT DISTINCT DEPARTMENT_ID, DEPARTMENT_NAME, PROV_NM_WID, PROV_ID,
                           SLOT_BEGIN_TIME, SLOT_DATE, TO_CHAR(SLOT_DATE, 'yyyy-mm') AS SLOT_MONTH_YEAR, SLOT_LENGTH
                           FROM V_AVAILABILITY
                           WHERE UNAVAILABLE_RSN_C IS NULL 
                           AND ORG_REG_OPENINGS>0
                           AND SLOT_DATE BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
                           AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS'))
                           GROUP BY DEPARTMENT_ID, DEPARTMENT_NAME, PROV_NM_WID, PROV_ID, SLOT_DATE, SLOT_MONTH_YEAR;")


availability_access_index <- glue("CREATE index availability_access_index on AMBULATORY_AVAILABILITY_ACCESS_TABLE (SLOT_DATE, DEPARTMENT_ID)")

overbook_raw_drop <- glue("DROP TABLE AMBULATORY_OVERBOOK_TABLE")
overbook_raw_query <- glue("CREATE TABLE AMBULATORY_OVERBOOK_TABLE AS
                           SELECT c.DEPARTMENT_ID, c.PROV_ID, c.SLOT_DATE, sum(c.SLOT_LENGTH) AS OVERBOOKED_MINS_V2
                           FROM
                           (SELECT a.*, b.APPT_NUMBER, b.SLOT_LENGTH
                           FROM(
                           (SELECT * FROM AMBULATORY_ACCESS_RAW_FILTERED
                           WHERE (APPT_STATUS IN ('Arrived', 'No Show','Scheduled')) OR
                           (APPT_STATUS IN  ('Canceled', 'Rescheduled', 'Bumped') AND 
                            TO_CHAR(APPT_DTTM, 'YYYY-MM-DD') = TO_CHAR(APPT_CANC_DTTM, 'YYYY-MM-DD'))) a
                           LEFT JOIN
                           (SELECT PAT_ENC_CSN_ID, DEPARTMENT_ID, DEPARTMENT_NAME, PROV_NM_WID, PROV_ID,
                           SLOT_BEGIN_TIME, SLOT_DATE, SLOT_LENGTH, APPT_NUMBER, UNAVAILABLE_RSN_C
                           FROM V_AVAILABILITY
                           WHERE UNAVAILABLE_RSN_C IS NULL) b
                           ON a.PAT_ENC_CSN_ID = b.PAT_ENC_CSN_ID 
                           AND a.DEPARTMENT_ID = b.DEPARTMENT_ID
                           AND a.APPT_DTTM = b.SLOT_BEGIN_TIME)
                           WHERE APPT_NUMBER IN (2, 3))c
                           GROUP BY c.DEPARTMENT_ID, c.PROV_ID, c.SLOT_DATE")

overbook_raw_index <- glue("CREATE index overbook_raw_index on AMBULATORY_OVERBOOK_TABLE (SLOT_DATE, DEPARTMENT_ID)")



### Combine all final tables and map the campus column
slot_table_drop <- glue("DROP TABLE AMBULATORY_SLOT_TABLE")
slot_table_quary <- glue("CREATE TABLE AMBULATORY_SLOT_TABLE AS
                            SELECT f.*, g.holiday, 
                            h.UNAVAILABLE_MINS, i.HELD_MINS, 
                            j.PRIVATE_MINS, k.OVERBOOKED_MINS, l.OVERBOOKED_MINS_V2
                            FROM
                            (
                              SELECT e.CAMPUS, e.DEPARTMENT_ID, e.DEPARTMENT, e.CAMPUS_SPECIALTY, c.NPI,  
                              c.VISIT_PROV_STAFF_RESOURCE_C, 
                              c.PROV_ID, TRIM(TRAILING FROM REGEXP_REPLACE(PROV_NM_WID, '\\[(.*?)\\]', '')) AS Provider, 
                              c.SLOT_DATE, c.SLOT_MONTH_YEAR, c.SLOT_DATE - (TO_CHAR(c.SLOT_DATE, 'D') - 1) AS APPT_WEEK, 
                              c.AVAILABLE_MINS, c.SCHEDULED_MINS, c.ARRIVED_MINS, TO_CHAR(c.SLOT_DATE, 'DY') AS APPT_DAY 
                              FROM
                              (
                                SELECT s.*, b.DEPT_SPECIALTY_NAME, b.SCHEDULED_MINS, b.ARRIVED_MINS 
                                FROM
                                (SELECT r.*, a.AVAILABLE_MINS
                                FROM
                                (
                                  SELECT * FROM AMBULATORY_BASE_SLOT_TABLE
                                ) r
                                LEFT JOIN
                                (
                                  SELECT * FROM AMBULATORY_AVAILABILITY_ACCESS_TABLE
                                ) a
                                ON r.DEPARTMENT_ID = a.DEPARTMENT_ID AND 
                                   r.DEPARTMENT_NAME = a.DEPARTMENT_NAME AND
                                   r.PROV_NM_WID = a.PROV_NM_WID AND
                                   r.PROV_ID = a.PROV_ID AND
                                   r.SLOT_DATE = a.SLOT_DATE AND
                                   r.SLOT_MONTH_YEAR = a.SLOT_MONTH_YEAR
                                ) s
                                LEFT JOIN
                                (
                                  SELECT * FROM AMBULATORY_ACCESS_SCHED_ARRIVED_HOURS
                                ) b
                                ON s.DEPARTMENT_ID = b.DEPARTMENT_ID AND s.PROV_ID = b.PROV_ID AND s.SLOT_DATE = b.APPT_DATE
                              ) c
                              LEFT JOIN
                              (
                                SELECT DISTINCT CAMPUS, CAMPUS_SPECIALTY, DEPARTMENT_ID, DEPARTMENT 
                                FROM AMBULATORY_SLOT_MAPPING
                              ) e 
                              ON c.DEPARTMENT_ID = e.DEPARTMENT_ID
                            ) f
                            LEFT JOIN
                            villea04.holidays g ON f.SLOT_DATE = g.dates
                            LEFT JOIN
                            (
                              SELECT DEPARTMENT_ID, PROV_ID, SLOT_DATE, SUM(SLOT_LENGTH) AS UNAVAILABLE_MINS
                              FROM(
                              SELECT DISTINCT DEPARTMENT_ID, PROV_ID, SLOT_DATE, SLOT_BEGIN_TIME, SLOT_LENGTH
                              FROM V_AVAILABILITY 
                              WHERE UNAVAILABLE_RSN_C IS NOT NULL 
                              AND SLOT_DATE BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
                              AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS'))
                              GROUP BY DEPARTMENT_ID, PROV_ID, SLOT_DATE
                            ) h
                            ON f.DEPARTMENT_ID = h.DEPARTMENT_ID AND f.PROV_ID = h.PROV_ID AND f.SLOT_DATE = h.SLOT_DATE
                            LEFT JOIN
                            (
                              SELECT DEPARTMENT_ID, PROV_ID, SLOT_DATE, SUM(SLOT_LENGTH) AS HELD_MINS
                              FROM(
                              SELECT DISTINCT DEPARTMENT_ID, PROV_ID, SLOT_DATE, SLOT_BEGIN_TIME, SLOT_LENGTH
                              FROM V_AVAILABILITY 
                              WHERE UNAVAILABLE_RSN_C IS NULL 
                              AND TIME_HELD_YN = 'Y'
                              AND SLOT_DATE BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
                              AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS'))
                              GROUP BY DEPARTMENT_ID, PROV_ID, SLOT_DATE
                            ) i
                            ON f.DEPARTMENT_ID = i.DEPARTMENT_ID AND f.PROV_ID = i.PROV_ID AND f.SLOT_DATE = i.SLOT_DATE
                            LEFT JOIN
                            (
                              SELECT DEPARTMENT_ID, PROV_ID, SLOT_DATE, SUM(SLOT_LENGTH) AS PRIVATE_MINS
                              FROM(
                              SELECT DISTINCT DEPARTMENT_ID, PROV_ID, SLOT_DATE, SLOT_BEGIN_TIME, SLOT_LENGTH
                              FROM V_AVAILABILITY 
                              WHERE UNAVAILABLE_RSN_C IS NULL 
                              AND PRIVATE_YN = 'Y'
                              AND SLOT_DATE BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
                              AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS'))
                              GROUP BY DEPARTMENT_ID, PROV_ID, SLOT_DATE
                            ) j
                            ON f.DEPARTMENT_ID = j.DEPARTMENT_ID AND f.PROV_ID = j.PROV_ID AND f.SLOT_DATE = j.SLOT_DATE
                            LEFT JOIN
                            (
                              SELECT DEPARTMENT_ID, PROV_ID, SLOT_DATE, 
                              SUM(SLOT_LENGTH) AS OVERBOOKED_MINS
                              FROM V_AVAILABILITY 
                              WHERE UNAVAILABLE_RSN_C IS NULL 
                              AND ORG_OVBK_OPENINGS > 0
                              AND SLOT_DATE BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
                              AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
                              GROUP BY DEPARTMENT_ID, PROV_ID, SLOT_DATE
                            ) k
                            ON f.DEPARTMENT_ID = k.DEPARTMENT_ID AND f.PROV_ID = k.PROV_ID AND f.SLOT_DATE = k.SLOT_DATE
                            LEFT JOIN
                            (
                            SELECT DEPARTMENT_ID, PROV_ID, SLOT_DATE, OVERBOOKED_MINS_V2
                            FROM AMBULATORY_OVERBOOK_TABLE
                            )l
                            ON f.DEPARTMENT_ID = l.DEPARTMENT_ID AND f.PROV_ID = l.PROV_ID AND f.SLOT_DATE = l.SLOT_DATE
                            ")

slot_table_index <- glue("CREATE index slot_table_index on AMBULATORY_SLOT_TABLE (SLOT_DATE, DEPARTMENT_ID, CAMPUS)")

#poolcon_upt <- dbConnect(odbc(), "OAO Cloud DB Staging", timeout = 15)


## Grouped Table execution
  tryCatch({
        poolcon_upt <- dbConnect(drv = odbc(), "OAO Cloud DB Production", timeout = 30)
        dbBegin(poolcon_upt)
             if(dbExistsTable(poolcon_upt, "AMBULATORY_SLOT_MAPPING")){
          dbExecute(poolcon_upt, slot_mapping_drop) 
              }
          dbExecute(poolcon_upt, slot_mapping) 
            if(dbExistsTable(poolcon_upt, "AMBULATORY_ACCESS_RAW_FILTERED")){
          dbExecute(poolcon_upt, raw_access_drop) 
            }
          dbExecute(poolcon_upt, raw_access_query) 
          dbExecute(poolcon_upt, raw_access_index)
            if(dbExistsTable(poolcon_upt, "AMBULATORY_ACCESS_SCHED_ARRIVED_HOURS")){
          dbExecute(poolcon_upt, access_sched_arived_hours_drop) 
            }
          dbExecute(poolcon_upt, access_sched_arived_hours_quary) 
          dbExecute(poolcon_upt, access_sched_arived_hours_index)
           if(dbExistsTable(poolcon_upt, "AMBULATORY_BASE_SLOT_TABLE")){
           dbExecute(poolcon_upt, base_slot_drop) 
            }
           dbExecute(poolcon_upt, base_slot_query) 
           dbExecute(poolcon_upt, base_slot_index)
           if(dbExistsTable(poolcon_upt, "AMBULATORY_AVAILABILITY_ACCESS_TABLE")){
           dbExecute(poolcon_upt, availability_raw_drop) 
            }
           dbExecute(poolcon_upt, availability_raw_query) 
           dbExecute(poolcon_upt, availability_access_index)
             if(dbExistsTable(poolcon_upt, "AMBULATORY_OVERBOOK_TABLE")){
          dbExecute(poolcon_upt, overbook_raw_drop) 
            }
          dbExecute(poolcon_upt, overbook_raw_query) 
          dbExecute(poolcon_upt, overbook_raw_index)
          
           if(dbExistsTable(poolcon_upt, "AMBULATORY_SLOT_TABLE")){
           dbExecute(poolcon_upt, slot_table_drop) 
             }
           dbExecute(poolcon_upt, slot_table_quary) 
           dbExecute(poolcon_upt, slot_table_index)


        
        dbCommit(poolcon_upt)
        dbDisconnect(poolcon_upt)
        print("success")

  },
  error = function(err){
    print("error staging")
    dbRollback(poolcon_upt)
    dbDisconnect(poolcon_upt)
  })

```

